<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>P2P Capsule MVP — WebRTC + Local Vault + QR + IPFS/IPNS</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

  <style>
    :root { --bg:#0e0f12; --fg:#e7e9ee; --muted:#a8adbc; --accent:#6ae3ff; --card:#161821; --ok:#3bd671; --warn:#ffcc66; --err:#ff6b6b; }
    html, body { height:100%; background:var(--bg); color:var(--fg); font:14px/1.4 system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    h1,h2 { margin: 0.6rem 0; }
    a { color: var(--accent); }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .card { background:var(--card); border:1px solid #222534; border-radius:14px; padding:12px; box-shadow: 0 2px 12px rgb(0 0 0 / 0.25); }
    input, button, textarea, select { background:#0f121a; color:var(--fg); border:1px solid #2a2f44; border-radius:10px; padding:8px 10px; outline:none; }
    button { cursor:pointer; }
    textarea { width:100%; min-height: 120px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .pill { display:inline-block; padding:4px 8px; border-radius: 999px; background:#101320; border:1px solid #23283d; color:var(--muted); font-size:12px; }
    .ok { color:var(--ok); } .warn { color:var(--warn);} .err { color:var(--err);} .muted{color:var(--muted)}
    .tabs { display:flex; gap:8px; margin: 8px 0 12px; flex-wrap: wrap; }
    .tabs button { background:#121624; }
    .hidden { display:none !important; }
    #chatLog { height:180px; overflow:auto; background:#0f121a; padding:8px; border-radius:8px; }
    #videoSelf,#videoPeer { width:100%; background:#000; border-radius:10px; }
    .meter { height:8px; border-radius:6px; background:#0c0f18; border:1px solid #22283a; overflow:hidden }
    .meter > div { height:100%; background:linear-gradient(90deg,#3bd671,#6ae3ff); width:0% }
    .small { font-size:12px }
    pre { white-space:pre-wrap; word-break:break-word; background:#0f121a; padding:8px; border-radius:8px; border:1px solid #2a2f44; }
    #map { height: 500px; border-radius: 10px; overflow: hidden; }
    .leaflet-container { background: #0f121a; }
  </style>

  <!-- Minimal QR generator (tiny, placeholder-quality; swap for full lib later) -->
  <script>
  (function(){function QR(v,e){this.v=v||4;this.e=e||1;this.modules=null;this.moduleCount=0;this.data='';}
  QR.prototype.addData=function(s){this.data=s};
  QR.prototype.getModuleCount=function(){return this.moduleCount};
  QR.prototype.make=function(){var s=this.data||'';var n=Math.max(21,Math.ceil(Math.sqrt(s.length*8))+10);this.moduleCount=n;this.modules=[];for(var y=0;y<n;y++){this.modules[y]=[];for(var x=0;x<n;x++){this.modules[y][x]=((x*31+y*17+s.length)%7)<3;}}};
  QR.prototype.isDark=function(x,y){return this.modules[x][y]};
  QR.prototype.renderTo2dContext=function(ctx,scale){var n=this.moduleCount;ctx.canvas.width=ctx.canvas.height=n*scale;ctx.fillStyle='#fff';ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height);for(var y=0;y<n;y++){for(var x=0;x<n;x++){if(this.modules[y][x]){ctx.fillStyle='#000';ctx.fillRect(x*scale,y*scale,scale,scale);}}}};
  window.QRCode=QR;})();
  </script>
</head>
<body>
<div class="wrap">
  <h1>P2P Capsule MVP <span class="pill">WebRTC + Local Vault</span></h1>
  <p class="muted">Single-file demo: manual/QR signalling, public STUN/TURN (optional), encrypted DataChannel file transfer, local vault (User Folder or OPFS), camera preview, offline PWA. Replace TURN creds before real use.</p>

  <div class="tabs">
    <button data-tab="connect">Connect</button>
    <button data-tab="chat">Chat</button>
    <button data-tab="files">Files</button>
    <button data-tab="map">Map</button>
    <button data-tab="vault">Vault</button>
    <button data-tab="camera">Camera</button>
    <button data-tab="publish">Publish</button>
    <button data-tab="tests">Tests</button>
  </div>

  <section id="tab-connect" class="card">
    <h2>Connect</h2>
    <div class="row">
      <label>Security passphrase (derives room key)</label>
      <input id="passphrase" placeholder="enter or generate" class="mono" size="32" />
      <button id="btnGenPass">Generate</button>
      <span id="keyStatus" class="pill">no key</span>
    </div>

    <div class="grid">
      <div class="card">
        <h3>1) Create Offer</h3>
        <div class="row"><button id="btnCreate">Create Peer (Offer)</button><span id="iceStatus" class="pill">idle</span></div>
        <textarea id="offerOut" placeholder="Offer (copy/share)"></textarea>
        <div class="row">
          <button id="btnOfferQR">Show Offer QR</button>
        </div>
        <div class="row">
          <label>Paste Answer:</label>
          <textarea id="answerIn" placeholder="Paste remote answer here"></textarea>
        </div>
        <div class="row">
          <button id="btnScanAnswer">Scan Answer QR</button>
          <button id="btnAcceptAnswer">Accept Answer</button>
        </div>
      </div>
      <div class="card">
        <h3>2) Join with Offer</h3>
        <textarea id="offerIn" placeholder="Paste remote offer here"></textarea>
        <div class="row">
          <button id="btnScanOffer">Scan Offer QR</button>
          <button id="btnAnswer">Create & Return Answer</button>
        </div>
        <textarea id="answerOut" placeholder="Answer (send back)"></textarea>
        <div class="row">
          <button id="btnAnswerQR">Show Answer QR</button>
        </div>
      </div>
    </div>

    <p class="small muted">Transport: DTLS/SRTP/SCTP end-to-end. Public STUN and optional public TURN are configured below. TURN can see IPs and timing, not content.</p>

    <div class="card">
      <h3>ICE Servers</h3>
      <p class="small muted">Replace TURN creds for production. TURN is used only if direct P2P fails.</p>
      <textarea id="iceJson" class="mono" style="min-height:100px">[
  {"urls": ["stun:stun.l.google.com:19302", "stun:stun.cloudflare.com:3478"]},
  {"urls": ["turns:openrelay.metered.ca:443?transport=tcp"], "username":"openrelayproject", "credential":"openrelayproject"},
  {"urls": ["turn:openrelay.metered.ca:80?transport=tcp"], "username":"openrelayproject", "credential":"openrelayproject"}
]</textarea>
      <div class="row"><button id="btnApplyIce">Apply ICE</button><span id="iceApplied" class="pill">default</span></div>
    </div>
  </section>

  <section id="tab-publish" class="card hidden">
    <h2>Publish (IPFS/IPNS)</h2>
    <p class="muted small">Use <b>subdomain gateways</b> for camera/mic & service worker support. You don't need to host your own gateway.</p>
    <h3>A) One-time setup</h3>
    <pre class="small mono">ipfs init
ipfs daemon   # keep this running</pre>
    <h3>B) Publish this file</h3>
    <pre class="small mono"># Save as index.html (use build output from dist-inline/)
ipfs add --cid-version=1 --hash=sha2-256 index.html
# → added &lt;CID&gt; index.html

# Subdomain gateway URL (full browser privileges):
https://&lt;CID&gt;.ipfs.dweb.link/

# Stable IPNS URL (update without changing link)
ipfs key gen capsule --type=ed25519
ipfs name publish --key=capsule /ipfs/&lt;CID&gt;
# → https://&lt;PeerID-of-capsule&gt;.ipns.dweb.link/</pre>
    <h3>C) Optional Node helper (publish.mjs)</h3>
    <pre class="small mono">// node publish.mjs index.html capsule
import {execSync} from 'node:child_process';
const [,, f, key='capsule'] = process.argv;
if(!f) throw new Error('usage: node publish.mjs index.html [key]');
const cid = execSync(`ipfs add --cid-version=1 --hash=sha2-256 -q ${f}`, {stdio:'pipe'}).toString().trim().split('\n').pop();
const res = execSync(`ipfs name publish --key=${key} /ipfs/${cid}`, {stdio:'pipe'}).toString();
console.log({cid, res});
console.log(`https://${cid}.ipfs.dweb.link/`);
</pre>
  </section>

  <section id="tab-chat" class="card hidden">
    <h2>Chat</h2>
    <div id="chatLog" class="mono"></div>
    <div class="row"><input id="chatInput" placeholder="message" style="flex:1"/><button id="btnSend">Send</button></div>
  </section>

  <section id="tab-files" class="card hidden">
    <h2>File Transfer</h2>
    <div class="row">
      <input type="file" id="filePick" multiple />
      <button id="btnSendFiles">Send</button>
      <span id="sendStatus" class="pill">idle</span>
    </div>
    <div>
      <div class="meter"><div id="sendMeter"></div></div>
      <div class="meter" style="margin-top:6px"><div id="recvMeter"></div></div>
    </div>
    <div id="recvList" class="small" style="margin-top:8px"></div>
  </section>

  <section id="tab-map" class="card hidden">
    <h2>Map & Location Sharing</h2>
    <p class="muted small">Share your location via device GPS, address lookup, or manual coordinates. Send exact location or H3 hex. Uses OpenStreetMap tiles (fair use policy applies). Nominatim geocoding has rate limits.</p>
    
    <div class="grid" style="margin-bottom:12px;">
      <div class="card">
        <h3 class="small">Your Location</h3>
        <div class="row">
          <button id="btnDeviceLocation">Device GPS</button>
          <span id="locationStatus" class="pill">idle</span>
        </div>
        <div class="row">
          <input id="addressInput" placeholder="Type address" style="flex:1"/>
          <button id="btnGeocodeAddress">Lookup</button>
        </div>
        <div class="row">
          <input id="latInput" placeholder="Latitude" size="12" type="number" step="any"/>
          <input id="lngInput" placeholder="Longitude" size="12" type="number" step="any"/>
          <button id="btnManualLocation">Set</button>
        </div>
        <div class="row">
          <label class="small">H3 Resolution:</label>
          <select id="h3ResolutionSelect">
            <option value="7">7 (~5km)</option>
            <option value="8">8 (~1km)</option>
            <option value="9" selected>9 (~174m)</option>
            <option value="10">10 (~65m)</option>
            <option value="11">11 (~25m)</option>
          </select>
        </div>
      </div>

      <div class="card">
        <h3 class="small">Share Location</h3>
        <div class="row">
          <button id="btnShareExact">Send Exact Coords</button>
        </div>
        <div class="row">
          <button id="btnShareH3">Send H3 Hex</button>
        </div>
        <div class="row">
          <input id="pinLabel" placeholder="Pin label (optional)" style="flex:1"/>
        </div>
        <p class="small muted">Click map to drop a pin at any location</p>
        <div class="row">
          <button id="btnClearMap">Clear Markers</button>
        </div>
      </div>
    </div>

    <div id="map"></div>
  </section>

  <section id="tab-vault" class="card hidden">
    <h2>Local Vault</h2>
    <p class="muted small">Encrypted-at-rest using AES-GCM with key derived from passphrase. Stores to a user folder (if permitted) or browser OPFS. Thumbnails have no EXIF.</p>
    <div class="row">
      <button id="btnChooseFolder">Choose Folder</button>
      <span id="vaultWhere" class="pill">not set</span>
      <button id="btnExportVault">Export Encrypted CAR (demo)</button>
    </div>
    <div class="row">
      <input type="file" id="vaultImport" multiple />
      <button id="btnVaultAdd">Add to Vault</button>
      <span id="vaultStatus" class="pill">idle</span>
    </div>
    <div id="vaultList" class="small"></div>
  </section>

  <section id="tab-camera" class="card hidden">
    <h2>Camera</h2>
    <div class="row">
      <button id="btnCam">Enable camera + mic</button>
      <span id="camStatus" class="pill">off</span>
    </div>
    <div class="grid">
      <video id="videoSelf" playsinline autoplay muted></video>
      <video id="videoPeer" playsinline autoplay></video>
    </div>
  </section>

  <section id="tab-tests" class="card hidden">
    <h2>Self‑Tests</h2>
    <p class="small muted">Runs basic checks for the most error‑prone parts (DOM existence, QR modal, packet framing, crypto derive).</p>
    <div class="row"><button id="btnRunTests">Run Tests</button><span id="testStatus" class="pill">idle</span></div>
    <pre id="testLog" class="small mono"></pre>
  </section>
</div>

<!-- QR modal (click outside or press ESC to close) -->
<div id="qrModal" class="hidden" role="dialog" aria-modal="true" aria-labelledby="qrTitle" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999;">
  <div id="qrBox" style="background:#0f121a;border:1px solid #2a2f44;padding:16px;border-radius:12px;max-width:90vw" tabindex="-1">
    <div class="row" style="justify-content:space-between"><b id="qrTitle" class="mono">QR</b><button id="qrClose">Close</button></div>
    <canvas id="qrCanvas" style="display:block;margin:auto"></canvas>
    <div class="row" style="margin-top:8px">
      <video id="qrVideo" playsinline muted style="max-width:60vw;max-height:40vh;display:none;background:#000"></video>
      <span id="qrHint" class="small muted"></span>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<!-- H3 JS -->
<script src="https://unpkg.com/h3-js@4.1.0/dist/h3-js.umd.js" crossorigin=""></script>

<script type="module" src="/src/main.js"></script>
</body>
</html>
